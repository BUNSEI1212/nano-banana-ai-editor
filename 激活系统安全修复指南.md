# 🔒 激活系统安全修复指南

## 🚨 **发现的安全漏洞**

### 问题描述
同一个激活码可以在多台设备上使用，违反了"一码一用"的设计原则。

### 漏洞原因
1. **本地验证模式缺陷**：只检查当前设备的激活历史，不检查全局使用状态
2. **数据库约束问题**：`UNIQUE(activation_code, device_id)` 允许同一激活码在不同设备上激活
3. **服务器验证未启用**：桌面应用默认使用本地验证模式

## ✅ **修复方案**

### 1. 启用服务器验证模式
```bash
# 在 nano-banana-desktop/backend/.env 中添加
ENABLE_SERVER_VERIFICATION=true
ACTIVATION_SERVER_URL=http://43.142.153.33:3001
```

### 2. 修复数据库约束
```sql
-- 修改前：允许同一激活码在不同设备上使用
UNIQUE(activation_code, device_id)

-- 修改后：激活码全局唯一
activation_code TEXT NOT NULL UNIQUE
```

### 3. 添加服务器端检查
```javascript
// 检查激活码是否已在任何设备上使用
const existingAnyActivation = await dbService.getActivationByCode(activationCode);
if (existingAnyActivation) {
  throw new Error('激活码已在其他设备上使用，每个激活码只能使用一次');
}
```

## 🚀 **部署修复**

### 云服务器修复步骤

```bash
# 1. 连接云服务器
ssh root@43.142.153.33

# 2. 进入后端目录
cd /www/wwwroot/nano-banana/backend

# 3. 备份数据库
cp data/proxy.db data/proxy.db.backup.$(date +%Y%m%d_%H%M%S)

# 4. 下载修复脚本
wget https://raw.githubusercontent.com/BUNSEI1212/nano-banana-ai-editor/main/fix-activation-security.js

# 5. 安装依赖（如果需要）
npm install sqlite3

# 6. 运行修复脚本
node fix-activation-security.js

# 7. 重启服务
pm2 restart nano-banana-backend

# 8. 验证修复
node test-activation-security.js
```

### 桌面应用修复

1. **重新构建应用**：
   ```bash
   cd nano-banana-desktop
   npm run build
   ```

2. **或者手动修改现有安装**：
   - 找到应用安装目录
   - 修改 `backend/.env` 文件
   - 添加服务器验证配置

## 🧪 **验证修复**

### 测试脚本
```bash
# 运行安全测试
node test-activation-security.js
```

### 预期结果
- ✅ 第一台设备激活成功
- ✅ 第二台设备激活失败（正确行为）
- ✅ 第一台设备重新激活成功

### 手动测试
1. 在第一台电脑上激活应用
2. 在第二台电脑上使用同一激活码
3. 应该显示"激活码已被使用"错误

## 📊 **修复效果**

### 修复前
- ❌ 同一激活码可在多台设备使用
- ❌ 无设备绑定验证
- ❌ 本地验证容易绕过

### 修复后
- ✅ 激活码全局唯一，一码一用
- ✅ 设备指纹绑定验证
- ✅ 服务器端强制验证
- ✅ 实时状态同步

## 🔄 **后续建议**

1. **定期安全审计**：每月检查激活数据
2. **监控异常激活**：设置重复激活告警
3. **用户教育**：说明激活码使用规则
4. **技术升级**：考虑硬件绑定等更强验证

## 📞 **技术支持**

如果修复过程中遇到问题：
1. 检查服务器连接状态
2. 验证数据库文件权限
3. 查看PM2服务日志
4. 联系技术支持团队

---

**修复完成后，激活系统将确保真正的"一码一用"！** 🔒